<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Crypto Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        .hidden { display: none; }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 font-sans text-white flex items-center justify-center min-h-screen">

    <div class="max-w-md w-full bg-gray-800 rounded-2xl shadow-2xl p-6 relative overflow-hidden">
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
        </div>

        <!-- Initial Screen: Create or Import -->
        <div id="initial-screen">
            <h1 class="text-3xl font-bold mb-2 text-center text-indigo-400">Welcome</h1>
            <p class="text-center text-gray-400 mb-8">Create a new wallet or import an existing one.</p>
            <div class="space-y-4">
                <button id="show-create-wallet" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Create New Wallet</button>
                <button id="show-import-wallet" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">Import Wallet</button>
            </div>
        </div>
        
        <!-- Create Wallet Screen -->
        <div id="create-wallet-screen" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-center">Create Password</h2>
             <p class="text-center text-gray-400 mb-6">This password encrypts your wallet. Do not forget it.</p>
            <input type="password" id="create-password" placeholder="Enter a strong password" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <input type="password" id="confirm-password" placeholder="Confirm password" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <button id="create-wallet-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Create Wallet</button>
            <button class="back-button mt-4 w-full text-gray-400 hover:text-white">Back</button>
        </div>

        <!-- Import Wallet Screen -->
        <div id="import-wallet-screen" class="hidden">
             <h2 class="text-2xl font-bold mb-4 text-center">Import Wallet</h2>
             <p class="text-center text-gray-400 mb-6">Enter your private key and set a new password.</p>
            <textarea id="private-key-input" placeholder="Enter your private key" rows="3" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
            <input type="password" id="import-password" placeholder="Enter a new password" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <button id="import-wallet-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Import Wallet</button>
            <button class="back-button mt-4 w-full text-gray-400 hover:text-white">Back</button>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-center">Welcome Back!</h2>
            <p class="text-center text-gray-400 mb-6">Unlock your wallet with your password.</p>
            <input type="password" id="login-password" placeholder="Enter your password" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Unlock Wallet</button>
            <button id="logout-btn-login" class="mt-4 w-full text-gray-400 hover:text-white">Use a different wallet</button>
        </div>

        <!-- Main Wallet Interface -->
        <div id="wallet-interface" class="hidden">
            <!-- Header -->
            <div class="text-center mb-4">
                <select id="network-selector" class="bg-gray-700 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="ethereum">Ethereum Mainnet</option>
                    <option value="bsc">BNB Smart Chain</option>
                </select>
                <div class="mt-4 bg-gray-900 rounded-lg p-3">
                    <p class="text-sm text-gray-400">Your Address</p>
                    <p id="wallet-address" class="text-sm break-all"></p>
                    <button id="copy-address-btn" class="text-indigo-400 text-xs mt-1">Copy</button>
                </div>
                 <h2 id="wallet-balance" class="text-4xl font-bold mt-4"></h2>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-700 mb-4">
                <button id="assets-tab-btn" class="tab-button flex-1 py-2 border-b-2 border-transparent active">Assets</button>
                <button id="history-tab-btn" class="tab-button flex-1 py-2 border-b-2 border-transparent">History</button>
            </div>

            <!-- Assets Tab -->
            <div id="assets-tab-content">
                <ul id="token-list" class="space-y-3 h-48 overflow-y-auto pr-2">
                    <!-- Token items will be injected here -->
                </ul>
            </div>

            <!-- History Tab -->
            <div id="history-tab-content" class="hidden">
                <ul id="history-list" class="space-y-3 h-48 overflow-y-auto pr-2">
                    <li class="text-gray-500 text-center mt-4">No transactions this session.</li>
                </ul>
            </div>
            
             <!-- Action Buttons -->
            <div class="flex space-x-4 mt-6">
                <button id="show-send-modal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Send</button>
                <button id="logout-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">Lock Wallet</button>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <!-- Private Key Modal -->
    <div id="private-key-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-500 mb-4">SAVE THIS KEY!</h3>
            <p class="text-gray-300 mb-4">This is your private key. It's the only way to recover your wallet. Store it somewhere safe and secret.</p>
            <div class="bg-gray-900 p-4 rounded-lg break-all text-sm mb-6" id="new-private-key"></div>
            <button id="close-pk-modal" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">I Have Saved My Key</button>
        </div>
    </div>
    
    <!-- Send Modal -->
    <div id="send-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-md w-full">
            <h3 class="text-2xl font-bold mb-6 text-center">Send <span id="send-symbol"></span></h3>
            <input type="text" id="recipient-address" placeholder="Recipient Address" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <input type="text" id="send-amount" placeholder="Amount" class="bg-gray-700 border border-gray-600 text-white p-3 w-full rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <div id="send-feedback" class="text-sm text-center mb-4 min-h-[20px]"></div>
            <div class="flex space-x-4">
                <button id="send-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Send</button>
                <button id="close-send-modal" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const screens = {
            initial: document.getElementById('initial-screen'),
            create: document.getElementById('create-wallet-screen'),
            imports: document.getElementById('import-wallet-screen'),
            login: document.getElementById('login-screen'),
            wallet: document.getElementById('wallet-interface'),
        };
        const modals = {
            privateKey: document.getElementById('private-key-modal'),
            send: document.getElementById('send-modal'),
        };
        const overlays = {
            loading: document.getElementById('loading-overlay'),
        };
        const buttons = {
            showCreate: document.getElementById('show-create-wallet'),
            showImport: document.getElementById('show-import-wallet'),
            createWallet: document.getElementById('create-wallet-btn'),
            importWallet: document.getElementById('import-wallet-btn'),
            login: document.getElementById('login-btn'),
            logout: document.getElementById('logout-btn'),
            logoutLogin: document.getElementById('logout-btn-login'),
            back: document.querySelectorAll('.back-button'),
            closePkModal: document.getElementById('close-pk-modal'),
            showSendModal: document.getElementById('show-send-modal-btn'),
            closeSendModal: document.getElementById('close-send-modal'),
            send: document.getElementById('send-btn'),
            copyAddress: document.getElementById('copy-address-btn'),
            assetsTab: document.getElementById('assets-tab-btn'),
            historyTab: document.getElementById('history-tab-btn'),
        };
        const inputs = {
            createPass: document.getElementById('create-password'),
            confirmPass: document.getElementById('confirm-password'),
            privateKey: document.getElementById('private-key-input'),
            importPass: document.getElementById('import-password'),
            loginPass: document.getElementById('login-password'),
            recipient: document.getElementById('recipient-address'),
            amount: document.getElementById('send-amount'),
        };
        const displays = {
            walletAddress: document.getElementById('wallet-address'),
            walletBalance: document.getElementById('wallet-balance'),
            newPrivateKey: document.getElementById('new-private-key'),
            sendSymbol: document.getElementById('send-symbol'),
            sendFeedback: document.getElementById('send-feedback'),
            tokenList: document.getElementById('token-list'),
            historyList: document.getElementById('history-list'),
        };
        const tabs = {
            assets: document.getElementById('assets-tab-content'),
            history: document.getElementById('history-tab-content'),
        };
        const networkSelector = document.getElementById('network-selector');

        // --- Config ---
        const networks = {
            ethereum: {
                name: 'Ethereum Mainnet',
                rpcUrl: 'https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161', // Public RPC
                symbol: 'ETH',
                tokens: {
                    'USDT': '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                    'USDC': '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                    'SHIB': '0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE',
                }
            },
            bsc: {
                name: 'BNB Smart Chain',
                rpcUrl: 'https://bsc-dataseed.binance.org/',
                symbol: 'BNB',
                tokens: {
                    'BUSD': '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56',
                    'CAKE': '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82',
                }
            }
        };
        const erc20Abi = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function balanceOf(address) view returns (uint)",
        ];

        // --- State ---
        let wallet;
        let provider;
        let selectedChain = 'ethereum';
        let sessionHistory = [];

        // --- Functions ---
        const showScreen = (screenName) => {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
        };
        
        const showLoading = (show) => {
            overlays.loading.classList.toggle('hidden', !show);
        };
        
        const showModal = (modalName, show) => {
            modals[modalName].classList.toggle('hidden', !show);
        };

        const initializeApp = () => {
            const encryptedWallet = localStorage.getItem('encryptedWallet');
            if (encryptedWallet) {
                showScreen('login');
            } else {
                showScreen('initial');
            }
        };

        const setupWallet = async (decryptedWallet) => {
            wallet = decryptedWallet;
            await switchNetwork();
            displays.walletAddress.textContent = wallet.address;
            showScreen('wallet');
        };

        const switchNetwork = async () => {
            showLoading(true);
            try {
                selectedChain = networkSelector.value;
                provider = new ethers.providers.JsonRpcProvider(networks[selectedChain].rpcUrl);
                wallet = wallet.connect(provider);
                await updateAllBalances();
            } catch (error) {
                console.error("Failed to switch network:", error);
                alert("Could not connect to the network. Please check your connection or RPC URL.");
            } finally {
                showLoading(false);
            }
        };

        const updateAllBalances = async () => {
            const currentNetwork = networks[selectedChain];
            // Update native balance
            const balance = await wallet.getBalance();
            const formattedBalance = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
            displays.walletBalance.textContent = `${formattedBalance} ${currentNetwork.symbol}`;

            // Update token balances
            displays.tokenList.innerHTML = '';
            for (const [symbol, address] of Object.entries(currentNetwork.tokens)) {
                try {
                    const contract = new ethers.Contract(address, erc20Abi, provider);
                    const tokenBalance = await contract.balanceOf(wallet.address);
                    const decimals = await contract.decimals();
                    const formattedTokenBalance = parseFloat(ethers.utils.formatUnits(tokenBalance, decimals)).toFixed(2);

                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg';
                    li.innerHTML = `
                        <div>
                            <p class="font-bold">${symbol}</p>
                            <p class="text-sm text-gray-400">${currentNetwork.name}</p>
                        </div>
                        <p class="font-mono">${formattedTokenBalance}</p>
                    `;
                    displays.tokenList.appendChild(li);
                } catch (e) {
                    console.error(`Could not fetch balance for ${symbol}:`, e);
                }
            }
        };
        
        const renderHistory = () => {
            if(sessionHistory.length === 0) {
                 displays.historyList.innerHTML = '<li class="text-gray-500 text-center mt-4">No transactions this session.</li>';
                 return;
            }
            displays.historyList.innerHTML = '';
            sessionHistory.slice().reverse().forEach(tx => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg';
                li.innerHTML = `
                    <div>
                        <p class="font-bold">Sent ${tx.amount} ${tx.symbol}</p>
                        <p class="text-xs text-gray-400 break-all">To: ${tx.to}</p>
                    </div>
                    <p class="text-sm text-indigo-400">Completed</p>
                `;
                displays.historyList.appendChild(li);
            });
        };

        const handleLogout = () => {
            if (confirm("Are you sure you want to lock and use a different wallet? This will clear the current encrypted wallet from this browser.")) {
                localStorage.removeItem('encryptedWallet');
                wallet = null;
                sessionHistory = [];
                initializeApp();
            }
        };

        // --- Event Listeners ---
        buttons.showCreate.onclick = () => showScreen('create');
        buttons.showImport.onclick = () => showScreen('imports');
        buttons.back.forEach(btn => btn.onclick = () => showScreen('initial'));
        buttons.logoutLogin.onclick = handleLogout;
        buttons.logout.onclick = () => {
             wallet = null;
             showScreen('login');
        };

        buttons.createWallet.onclick = async () => {
            if (inputs.createPass.value !== inputs.confirmPass.value) {
                alert("Passwords do not match.");
                return;
            }
            if (inputs.createPass.value.length < 8) {
                alert("Password must be at least 8 characters long.");
                return;
            }
            showLoading(true);
            try {
                const newWallet = ethers.Wallet.createRandom();
                const encryptedWallet = await newWallet.encrypt(inputs.createPass.value);
                localStorage.setItem('encryptedWallet', encryptedWallet);
                displays.newPrivateKey.textContent = newWallet.privateKey;
                showModal('privateKey', true);
                await setupWallet(newWallet);
            } catch (error) {
                console.error("Wallet creation failed:", error);
                alert("Could not create wallet. Please try again.");
            } finally {
                showLoading(false);
            }
        };
        
        buttons.closePkModal.onclick = () => showModal('privateKey', false);

        buttons.importWallet.onclick = async () => {
            const pk = inputs.privateKey.value.trim();
            const pass = inputs.importPass.value;
            if (!pk.startsWith('0x') || pk.length !== 66) {
                 alert("Invalid private key format.");
                 return;
            }
            if (pass.length < 8) {
                alert("Password must be at least 8 characters long.");
                return;
            }
            showLoading(true);
            try {
                const importedWallet = new ethers.Wallet(pk);
                const encryptedWallet = await importedWallet.encrypt(pass);
                localStorage.setItem('encryptedWallet', encryptedWallet);
                await setupWallet(importedWallet);
            } catch (error) {
                console.error("Wallet import failed:", error);
                alert("Could not import wallet. Please check your private key.");
            } finally {
                showLoading(false);
            }
        };

        buttons.login.onclick = async () => {
            const encryptedWallet = localStorage.getItem('encryptedWallet');
            const pass = inputs.loginPass.value;
            if (!pass) {
                alert("Please enter your password.");
                return;
            }
            showLoading(true);
            try {
                const decryptedWallet = await ethers.Wallet.fromEncryptedJson(encryptedWallet, pass);
                await setupWallet(decryptedWallet);
            } catch (error) {
                console.error("Login failed:", error);
                alert("Incorrect password.");
            } finally {
                inputs.loginPass.value = '';
                showLoading(false);
            }
        };
        
        networkSelector.onchange = switchNetwork;

        buttons.copyAddress.onclick = () => {
            navigator.clipboard.writeText(wallet.address).then(() => {
                buttons.copyAddress.textContent = 'Copied!';
                setTimeout(() => { buttons.copyAddress.textContent = 'Copy'; }, 2000);
            });
        };

        // Tab logic
        buttons.assetsTab.onclick = () => {
            tabs.assets.classList.remove('hidden');
            tabs.history.classList.add('hidden');
            buttons.assetsTab.classList.add('active');
            buttons.historyTab.classList.remove('active');
        };
         buttons.historyTab.onclick = () => {
            tabs.history.classList.remove('hidden');
            tabs.assets.classList.add('hidden');
            buttons.historyTab.classList.add('active');
            buttons.assetsTab.classList.remove('active');
        };

        // Send modal logic
        buttons.showSendModal.onclick = () => {
            displays.sendSymbol.textContent = networks[selectedChain].symbol;
            inputs.recipient.value = '';
            inputs.amount.value = '';
            displays.sendFeedback.textContent = '';
            showModal('send', true);
        };
        buttons.closeSendModal.onclick = () => showModal('send', false);

        buttons.send.onclick = async () => {
            const recipient = inputs.recipient.value.trim();
            const amount = inputs.amount.value.trim();
            const currentNetwork = networks[selectedChain];

            if (!ethers.utils.isAddress(recipient)) {
                displays.sendFeedback.textContent = 'Invalid recipient address.';
                displays.sendFeedback.classList.add('text-red-500');
                return;
            }
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                 displays.sendFeedback.textContent = 'Invalid amount.';
                 displays.sendFeedback.classList.add('text-red-500');
                 return;
            }

            displays.sendFeedback.textContent = 'Sending...';
            displays.sendFeedback.classList.remove('text-red-500', 'text-green-500');
            showLoading(true);

            try {
                const tx = await wallet.sendTransaction({
                    to: recipient,
                    value: ethers.utils.parseEther(amount)
                });
                await tx.wait();

                sessionHistory.push({
                    to: recipient,
                    amount: amount,
                    symbol: currentNetwork.symbol,
                    hash: tx.hash
                });
                renderHistory();
                await updateAllBalances();

                displays.sendFeedback.textContent = `Successfully sent ${amount} ${currentNetwork.symbol}!`;
                displays.sendFeedback.classList.add('text-green-500');
                setTimeout(() => showModal('send', false), 2000);

            } catch (error) {
                console.error("Send transaction failed:", error);
                displays.sendFeedback.textContent = 'Transaction failed. Insufficient funds?';
                displays.sendFeedback.classList.add('text-red-500');
            } finally {
                showLoading(false);
            }
        };

        // --- Initial Load ---
        initializeApp();
    });
    </script>
</body>
</html>
